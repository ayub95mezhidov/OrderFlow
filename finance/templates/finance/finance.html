{% extends 'orders/base.html' %}
{% load static %}

{% block content %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container bg-white rounded shadow p-4 my-4">
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 col-lg-4 mb-3 mb-md-0">
            <h2 class="col">Финансы</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-6 text-success">
            <h4>Кошелёк –
                <a href="{% url 'update_wallet' %}">
                    {{ wallet.cash|floatformat:2 }} ₽
                </a>
            </h4>
        </div>
        <div class="col-6 text-end text-danger">
            <h4>Вам должны –
                <a href="{% url 'update_debt' %}">
                    {{ debt.debt|floatformat:2 }} ₽
                </a>
            </h4>
        </div>
    </div>
</div>

<div class="container bg-white rounded shadow p-2 my-4">

    <!-- Переключатели периодов -->
    <div class="d-flex justify-content-center gap-3 mb-3">
        <a href="?period=day" class="btn btn-outline-primary {% if period == 'day' %}active{% endif %}">День</a>
        <a href="?period=week" class="btn btn-outline-primary {% if period == 'week' %}active{% endif %}">Неделя</a>
        <a href="?period=month" class="btn btn-outline-primary {% if period == 'month' %}active{% endif %}">Месяц</a>
    </div>

    <!-- Навигация -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="?period={{ period }}&offset={{ offset|add:-1 }}" class="btn btn-secondary btn-sm">← Назад</a>
        <h4 class="mb-0">{{ period_title }}</h4>
        <a href="?period={{ period }}&offset={{ offset|add:1 }}" class="btn btn-secondary btn-sm">Вперёд →</a>
    </div>

    <!-- Итоги -->
    <div class="row p-4">
        <div class="col-md-6">
            <div class="alert alert-info">
                <h3 class="d-flex justify-content-between">
                    <span>Доходы</span>
                    <span>{{ total_income }} ₽</span>
                </h3>
                {% if total_income != 0 %}
                <div class="mt-3" style="width: 350px; height:350px;">
                    <canvas id="incomeChart"></canvas>
                </div>
                {% else %}
                <h4 class="text-center">Нет доходов</h4>
                {% endif %}

                <div class="text-end">
                    <a class="btn btn-primary" href="{% url 'create_income' %}">+</a>
                </div>

            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-info">
                <h3 class="d-flex justify-content-between">
                    <span>Расходы</span>
                    <span>{{ total_expenses }} ₽</span>
                </h3>
                {% if total_expenses %}
                <div class="mt-3" style="width: 350px; height:350px;">
                    <canvas id="expenseChart"></canvas>
                </div>
                {% else %}
                <h4 class="text-center">Нет расходов</h4>
                {% endif %}

                <div class="text-end">
                    <a class="btn btn-primary" href="{% url 'create_expenses' %}">+</a>
                </div>

            </div>
        </div>

        <div class="col-12">
            <div class="alert alert-info">
                <h3 class="d-flex justify-content-between">
                    <span>Прибыль</span>
                    <span>{{ total_profit }} ₽</span>
                </h3>
            </div>
        </div>

    </div>

</div>


<div class="container bg-white rounded shadow p-2 my-4">

    <!-- Группировка по категориям -->
    <div class="row p-4">
        <div class="col-md-6">
            <div class="alert alert-info">
                <h5>Доходы</h5>
                <ul class="list-group">
                    {% for inc in incomes_grouped %}
                        <li class="list-group-item d-flex justify-content-between">
                            {{ inc.title__title }}
                            <span>{{ inc.total }} ₽</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item">Нет доходов</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="col-md-6">
            <div class="alert alert-info">
                <h5>Расходы</h5>
                <ul class="list-group">
                    {% for exp in expenses_grouped %}
                        <li class="list-group-item d-flex justify-content-between">
                            {{ exp.title__title }}
                            <span>{{ exp.total }} ₽</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item">Нет расходов</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>

</div>


<!-- Chart.js Скрипты -->
<script>

    const incomeData = {
        labels: {{ income_labels|safe }},
        datasets: [{
            data: {{ income_values|safe }},
            backgroundColor: {{ income_colors|safe }},
            borderWidth: 1
        }]
    };


    const expensesData = {
        labels: {{ expense_labels|safe }},
        datasets: [{
            data: {{ expense_values|safe }},
            backgroundColor: {{ expense_colors|safe }},
            borderWidth: 1
        }]
    };


    new Chart(document.getElementById("incomeChart"), {
        type: "pie",
        data: incomeData
    });

    new Chart(document.getElementById("expenseChart"), {
        type: "pie",
        data: expensesData
    });

    new Chart(document.getElementById("incomeChart"), {
        type: "pie",
        data: incomeData,
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

</script>

{% endblock %}
