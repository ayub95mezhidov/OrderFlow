{% extends 'orders/base.html' %}
{% load static %}

{% block content %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container bg-white rounded shadow p-3 p-md-4 my-3 my-md-4">
    <div class="row align-items-center mb-3 mb-md-4">
        <div class="col-12 col-md-6 col-lg-4 mb-2 mb-md-0">
            <h1 class="h4 h-md-2 mb-0">Финансы</h1>
        </div>
    </div>

    <div class="row g-2 g-md-3">
        <div class="col-12 col-md-6">
            <div class="d-flex align-items-center justify-content-between p-3 bg-success bg-opacity-10 rounded">
                <span class="text-success fw-medium">Кошелёк</span>
                <a href="{% url 'update_wallet' %}" class="text-success text-decoration-none">
                    <span class="fs-5 fw-bold">{{ wallet.cash|floatformat:2 }} ₽</span>
                </a>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="d-flex align-items-center justify-content-between p-3 bg-danger bg-opacity-10 rounded">
                <span class="text-danger fw-medium">Вам должны</span>
                <a href="{% url 'update_debt' %}" class="text-danger text-decoration-none">
                    <span class="fs-5 fw-bold">{{ debt.debt|floatformat:2 }} ₽</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container bg-white rounded shadow p-2 p-md-3 my-3 my-md-4">

    <!-- Переключатели периодов -->
    <div class="d-flex justify-content-center flex-wrap gap-2 gap-md-3 mb-3">
        <a href="?period=day" class="btn btn-outline-primary btn-sm {% if period == 'day' %}active{% endif %}">День</a>
        <a href="?period=week" class="btn btn-outline-primary btn-sm {% if period == 'week' %}active{% endif %}">Неделя</a>
        <a href="?period=month" class="btn btn-outline-primary btn-sm {% if period == 'month' %}active{% endif %}">Месяц</a>
    </div>

    <!-- Навигация -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="?period={{ period }}&offset={{ offset|add:-1 }}" class="btn btn-secondary btn-sm">
            <i class="d-none d-md-inline">←</i> Назад
        </a>
        <h4 class="h5 h4-md mb-0 text-center">{{ period_title }}</h4>
        <a href="?period={{ period }}&offset={{ offset|add:1 }}" class="btn btn-secondary btn-sm">
            Вперёд <i class="d-none d-md-inline">→</i>
        </a>
    </div>

    <!-- Итоги -->
    <div class="row g-3 g-md-4 p-2 p-md-4">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="alert alert-info h-100 d-flex flex-column">
                <h3 class="h5 h4-md d-flex justify-content-between align-items-center mb-3">
                    <span>Доходы</span>
                    <span class="fs-4">{{ total_income }} ₽</span>
                </h3>

                {% if total_income != 0 %}
                <div class="flex-grow-1 d-flex flex-column">
                    <div class="chart-container" style="min-height: 250px; max-height: 350px; position: relative;">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
                {% else %}
                <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                    <h4 class="h6 text-muted text-center mb-0">Нет доходов</h4>
                </div>
                {% endif %}

                <div class="text-end mt-3">
                    <a class="btn btn-primary btn-sm" href="{% url 'create_income' %}">
                        <i class="bi bi-plus"></i> Добавить
                    </a>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
            <div class="alert alert-info h-100 d-flex flex-column">
                <h3 class="h5 h4-md d-flex justify-content-between align-items-center mb-3">
                    <span>Расходы</span>
                    <span class="fs-4">{{ total_expenses }} ₽</span>
                </h3>

                {% if total_expenses %}
                <div class="flex-grow-1 d-flex flex-column">
                    <div class="chart-container" style="min-height: 250px; max-height: 350px; position: relative;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
                {% else %}
                <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                    <h4 class="h6 text-muted text-center mb-0">Нет расходов</h4>
                </div>
                {% endif %}

                <div class="text-end mt-3">
                    <a class="btn btn-primary btn-sm" href="{% url 'create_expenses' %}">
                        <i class="bi bi-plus"></i> Добавить
                    </a>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            <div class="alert alert-warning h-100 d-flex flex-column justify-content-center">
                <h3 class="h5 h4-md d-flex justify-content-between align-items-center mb-2">
                    <span>Прибыль</span>
                    <span class="fs-3 {% if total_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ total_profit }} ₽
                    </span>
                </h3>
                <div class="progress mt-2" style="height: 10px;">
                    {% if total_income > 0 %}
                    <div class="progress-bar bg-success" style="width: {{ profit_percentage|default:0 }}%"></div>
                    {% endif %}
                </div>
                <small class="text-muted mt-2">Рентабельность: {{ profit_percentage|default:0|floatformat:1 }}%</small>
            </div>
        </div>
    </div>
</div>

<div class="container bg-white rounded shadow p-2 p-md-3 my-3 my-md-4">
    <!-- Группировка по категориям -->
    <div class="row g-3 g-md-4 p-2 p-md-4">
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Доходы по категориям</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for inc in incomes_grouped %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate">{{ inc.title__title }}</span>
                                <span class="badge bg-primary rounded-pill">{{ inc.total }} ₽</span>
                            </div>
                        {% empty %}
                            <div class="list-group-item text-center text-muted py-4">
                                Нет доходов
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0 pt-3">
                    <div class="d-grid">
                        <a href="{% url 'create_income' %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-plus-circle"></i> Добавить доход
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Расходы по категориям</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for exp in expenses_grouped %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate">{{ exp.title__title }}</span>
                                <span class="badge bg-danger rounded-pill">{{ exp.total }} ₽</span>
                            </div>
                        {% empty %}
                            <div class="list-group-item text-center text-muted py-4">
                                Нет расходов
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0 pt-3">
                    <div class="d-grid">
                        <a href="{% url 'create_expenses' %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-plus-circle"></i> Добавить расход
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Скрипты -->
<script>
    // Функция для создания адаптивных графиков
    function createResponsiveChart(canvasId, data, type = "pie") {
        const ctx = document.getElementById(canvasId).getContext('2d');

        return new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: window.innerWidth < 768 ? 'bottom' : 'right',
                        labels: {
                            font: {
                                size: window.innerWidth < 768 ? 12 : 14
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.raw + ' ₽';
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Данные для графиков
    const incomeData = {
        labels: {{ income_labels|safe }},
        datasets: [{
            data: {{ income_values|safe }},
            backgroundColor: {{ income_colors|safe }},
            borderWidth: 1
        }]
    };

    const expensesData = {
        labels: {{ expense_labels|safe }},
        datasets: [{
            data: {{ expense_values|safe }},
            backgroundColor: {{ expense_colors|safe }},
            borderWidth: 1
        }]
    };

    // Создание графиков
    let incomeChart, expenseChart;

    // Инициализация графиков при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById("incomeChart")) {
            incomeChart = createResponsiveChart("incomeChart", incomeData, "pie");
        }

        if (document.getElementById("expenseChart")) {
            expenseChart = createResponsiveChart("expenseChart", expensesData, "pie");
        }
    });

    // Пересоздание графиков при изменении размера окна
    window.addEventListener('resize', function() {
        if (incomeChart) {
            incomeChart.destroy();
            incomeChart = createResponsiveChart("incomeChart", incomeData, "pie");
        }

        if (expenseChart) {
            expenseChart.destroy();
            expenseChart = createResponsiveChart("expenseChart", expensesData, "pie");
        }
    });
</script>

<!-- Стили для улучшения адаптивности -->
<style>
    @media (max-width: 768px) {
        .chart-container {
            height: 250px !important;
        }
        .fs-4 {
            font-size: 1.25rem !important;
        }
        .fs-3 {
            font-size: 1.5rem !important;
        }
        h1 {
            font-size: 1.5rem !important;
        }
        h2 {
            font-size: 1.3rem !important;
        }
        h3 {
            font-size: 1.1rem !important;
        }
        h4 {
            font-size: 1rem !important;
        }
        h5 {
            font-size: 0.9rem !important;
        }
    }

    @media (max-width: 576px) {
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .card-header h5 {
            font-size: 1rem;
        }
        .list-group-item {
            padding: 0.75rem 0.5rem;
        }
    }

    /* Улучшение отображения на очень маленьких экранах */
    @media (max-width: 360px) {
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }
        .btn {
            font-size: 0.8rem;
        }
    }
</style>

{% endblock %}